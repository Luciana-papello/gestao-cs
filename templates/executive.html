{% extends "base.html" %}

{% block title %}Visão Executiva - Dashboard Papello{% endblock %}

{% block content %}
<div class="container-fluid">
    
    <!-- Header da Página -->
    <div class="page-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="fas fa-chart-line me-3"></i>Visão Executiva</h1>
                    <p>Indicadores estratégicos de Customer Success da Papello</p>
                </div>
                <div class="col-md-4 text-md-end">
                    <button class="btn btn-outline-light btn-lg" onclick="refreshData()">
                        <i class="fas fa-sync-alt me-2"></i>Atualizar Dados
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="container">
        
        <!-- KPIs Principais -->
        <div class="section-header">
            <i class="fas fa-tachometer-alt section-icon"></i>
            <h2 class="section-title">Indicadores Principais</h2>
        </div>
        
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="metric-card info" id="card-total-clientes">
                    <i class="fas fa-users metric-icon"></i>
                    <div class="metric-title">Base de Clientes</div>
                    <div class="metric-value skeleton" data-skeleton="45px">---</div>
                    <div class="metric-trend">Carregando...</div>
                    <div class="metric-explanation">Total de clientes únicos que fizeram pedidos nos últimos 24 meses</div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="metric-card success" id="card-retencao">
                    <i class="fas fa-check-circle metric-icon"></i>
                    <div class="metric-title">Taxa de Retenção</div>
                    <div class="metric-value skeleton" data-skeleton="45px">---%</div>
                    <div class="metric-trend">Carregando...</div>
                    <div class="metric-explanation">Percentual de clientes que compraram recentemente (status Ativo)</div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="metric-card warning" id="card-criticos">
                    <i class="fas fa-exclamation-triangle metric-icon"></i>
                    <div class="metric-title">Clientes Críticos</div>
                    <div class="metric-value skeleton" data-skeleton="45px">---%</div>
                    <div class="metric-trend">Carregando...</div>
                    <div class="metric-explanation">Clientes Premium/Gold em risco ou com alta prioridade de ação</div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="metric-card success" id="card-receita">
                    <i class="fas fa-dollar-sign metric-icon"></i>
                    <div class="metric-title">Receita Total</div>
                    <div class="metric-value skeleton" data-skeleton="45px">R$ ---</div>
                    <div class="metric-trend">Carregando...</div>
                    <div class="metric-explanation">Soma de toda receita gerada pelos clientes da base ativa</div>
                </div>
            </div>
        </div>
        
        <!-- Análise de Recorrência -->
        <div class="section-header">
            <i class="fas fa-redo section-icon"></i>
            <h2 class="section-title">Análise de Recorrência de Clientes</h2>
        </div>
        
        <!-- Filtros de Data para Recorrência -->
        <div class="filters-container">
            <div class="filters-title">
                <i class="fas fa-filter"></i>
                Período de Análise
            </div>
            <div class="row align-items-end">
                <div class="col-md-3">
                    <label for="recurrence-start" class="form-label">Data Inicial</label>
                    <input type="date" class="form-control" id="recurrence-start" value="">
                </div>
                <div class="col-md-3">
                    <label for="recurrence-end" class="form-label">Data Final</label>
                    <input type="date" class="form-control" id="recurrence-end" value="">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Período Rápido</label>
                    <select class="form-select" id="quick-period">
                        <option value="30">Últimos 30 dias</option>
                        <option value="90">Últimos 3 meses</option>
                        <option value="180" selected>Últimos 6 meses</option>
                        <option value="365">Último ano</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-papello w-100" onclick="updateRecurrenceAnalysis()">
                        <i class="fas fa-search me-2"></i>Analisar Período
                    </button>
                </div>
            </div>
            <div class="mt-3">
                <small class="text-muted" id="period-info">Período: Últimos 6 meses</small>
            </div>
        </div>
        
        <!-- Cards de Recorrência -->
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="metric-card info" id="card-novos-clientes">
                    <i class="fas fa-user-plus metric-icon"></i>
                    <div class="metric-title">Novos Clientes</div>
                    <div class="metric-value skeleton" data-skeleton="45px">---</div>
                    <div class="metric-trend">Carregando...</div>
                    <div class="metric-explanation">Clientes que fizeram sua primeira compra no período</div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="metric-card success" id="card-recompras">
                    <i class="fas fa-redo metric-icon"></i>
                    <div class="metric-title">Recompras</div>
                    <div class="metric-value skeleton" data-skeleton="45px">---</div>
                    <div class="metric-trend">Carregando...</div>
                    <div class="metric-explanation">Pedidos de clientes que já haviam comprado antes</div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="metric-card warning" id="card-conversao">
                    <i class="fas fa-percentage metric-icon"></i>
                    <div class="metric-title">Taxa de Conversão</div>
                    <div class="metric-value skeleton" data-skeleton="45px">---%</div>
                    <div class="metric-trend">Carregando...</div>
                    <div class="metric-explanation">% de clientes únicos que fizeram primeira compra e depois recompraram</div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="metric-card success" id="card-ticket-recompra">
                    <i class="fas fa-shopping-cart metric-icon"></i>
                    <div class="metric-title">Ticket Recompra</div>
                    <div class="metric-value skeleton" data-skeleton="45px">R$ ---</div>
                    <div class="metric-trend">Carregando...</div>
                    <div class="metric-explanation">Valor médio dos pedidos de recompra vs primeira compra</div>
                </div>
            </div>
        </div>
        
        <!-- Gráficos de Recorrência -->
        <div class="row mb-4">
            <div class="col-lg-6 mb-3">
                <div class="chart-card">
                    <div class="chart-title">
                        <i class="fas fa-chart-pie"></i>
                        Distribuição no Período
                    </div>
                    <canvas id="chart-recurrence-pie"></canvas>
                </div>
            </div>
            
            <div class="col-lg-6 mb-3">
                <div class="chart-card">
                    <div class="chart-title">
                        <i class="fas fa-chart-bar"></i>
                        Comparação de Tickets Médios
                    </div>
                    <canvas id="chart-tickets-bar"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Status da Base de Clientes -->
        <div class="section-header">
            <i class="fas fa-users-cog section-icon"></i>
            <h2 class="section-title">Status da Base de Clientes</h2>
        </div>
        
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="metric-card info" id="card-base-total">
                    <i class="fas fa-database metric-icon"></i>
                    <div class="metric-title">Base Total</div>
                    <div class="metric-value skeleton" data-skeleton="45px">---</div>
                    <div class="metric-trend">Clientes únicos</div>
                    <div class="metric-explanation">Clientes com pelo menos 1 pedido nos últimos 24 meses</div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="metric-card success" id="card-ativos">
                    <i class="fas fa-heart metric-icon"></i>
                    <div class="metric-title">Ativos</div>
                    <div class="metric-value skeleton" data-skeleton="45px">---</div>
                    <div class="metric-trend">Carregando...</div>
                    <div class="metric-explanation">Compraram dentro do prazo esperado para seu perfil</div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="metric-card danger" id="card-inativos">
                    <i class="fas fa-heart-broken metric-icon"></i>
                    <div class="metric-title">Inativos</div>
                    <div class="metric-value skeleton" data-skeleton="45px">---</div>
                    <div class="metric-trend">Carregando...</div>
                    <div class="metric-explanation">Não compram há muito tempo (>3x intervalo normal)</div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="metric-card warning" id="card-dormant">
                    <i class="fas fa-bed metric-icon"></i>
                    <div class="metric-title">Dormant</div>
                    <div class="metric-value skeleton" data-skeleton="45px">---</div>
                    <div class="metric-trend">Carregando...</div>
                    <div class="metric-explanation">Atrasados para próxima compra (>2x intervalo normal)</div>
                </div>
            </div>
        </div>
        
        <!-- Avaliação do Cliente -->
        <div class="section-header">
            <i class="fas fa-smile section-icon"></i>
            <h2 class="section-title">Avaliação do Cliente</h2>
        </div>
        
        <!-- Filtros de Data para Satisfação -->
        <div class="filters-container">
            <div class="filters-title">
                <i class="fas fa-calendar-alt"></i>
                Período de Avaliação
            </div>
            <div class="row align-items-end">
                <div class="col-md-3">
                    <label for="satisfaction-start" class="form-label">Data Inicial</label>
                    <input type="date" class="form-control" id="satisfaction-start" value="">
                </div>
                <div class="col-md-3">
                    <label for="satisfaction-end" class="form-label">Data Final</label>
                    <input type="date" class="form-control" id="satisfaction-end" value="">
                </div>
                <div class="col-md-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="custom-period-satisfaction">
                        <label class="form-check-label" for="custom-period-satisfaction">
                            Personalizar período
                        </label>
                    </div>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-papello w-100" onclick="updateSatisfactionMetrics()">
                        <i class="fas fa-search me-2"></i>Analisar
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Métricas de Satisfação -->
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="metric-card info" id="card-atendimento">
                    <i class="fas fa-headset metric-icon"></i>
                    <div class="metric-title">Atendimento</div>
                    <div class="metric-value skeleton" data-skeleton="45px">---</div>
                    <div class="metric-trend">Carregando...</div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="metric-card info" id="card-produto">
                    <i class="fas fa-box metric-icon"></i>
                    <div class="metric-title">Produto</div>
                    <div class="metric-value skeleton" data-skeleton="45px">---</div>
                    <div class="metric-trend">Carregando...</div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="metric-card info" id="card-prazo">
                    <i class="fas fa-clock metric-icon"></i>
                    <div class="metric-title">Prazo</div>
                    <div class="metric-value skeleton" data-skeleton="45px">---</div>
                    <div class="metric-trend">Carregando...</div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="metric-card info" id="card-nps">
                    <i class="fas fa-chart-line metric-icon"></i>
                    <div class="metric-title">NPS</div>
                    <div class="metric-value skeleton" data-skeleton="45px">---</div>
                    <div class="metric-trend">Carregando...</div>
                </div>
            </div>
        </div>
        
        <!-- Análise Detalhada do NPS -->
        <div class="row mb-4" id="nps-detailed-analysis" style="display: none;">
            <div class="col-12">
                <div class="chart-card">
                    <div class="chart-title">
                        <i class="fas fa-microscope"></i>
                        Análise Completa do NPS
                        <button class="btn btn-sm btn-outline-secondary ms-auto" onclick="toggleNPSAnalysis()">
                            <i class="fas fa-eye-slash"></i> Ocultar
                        </button>
                    </div>
                    
                    <div class="row">
                        <div class="col-lg-6">
                            <h6 class="fw-bold mb-3">Categorização das Respostas</h6>
                            <div class="row">
                                <div class="col-6 col-lg-3 mb-2">
                                    <div class="text-center p-3 rounded" style="background: rgba(150, 202, 0, 0.1);">
                                        <div class="fw-bold text-success" id="nps-promotores">0</div>
                                        <small>Promotores</small>
                                    </div>
                                </div>
                                <div class="col-6 col-lg-3 mb-2">
                                    <div class="text-center p-3 rounded" style="background: rgba(245, 158, 11, 0.1);">
                                        <div class="fw-bold text-warning" id="nps-neutros">0</div>
                                        <small>Neutros</small>
                                    </div>
                                </div>
                                <div class="col-6 col-lg-3 mb-2">
                                    <div class="text-center p-3 rounded" style="background: rgba(239, 68, 68, 0.1);">
                                        <div class="fw-bold text-danger" id="nps-detratores">0</div>
                                        <small>Detratores</small>
                                    </div>
                                </div>
                                <div class="col-6 col-lg-3 mb-2">
                                    <div class="text-center p-3 rounded" style="background: rgba(59, 130, 246, 0.1);">
                                        <div class="fw-bold text-info" id="nps-total">0</div>
                                        <small>Total</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-4">
                                <h6 class="fw-bold mb-3">Interpretação do Resultado</h6>
                                <div id="nps-interpretation" class="alert alert-info">
                                    Carregando interpretação...
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-6">
                            <h6 class="fw-bold mb-3">Benchmarking</h6>
                            <div id="nps-benchmarks">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span>Média Global</span>
                                    <span class="badge bg-secondary" id="benchmark-global">32</span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span>Média Brasil</span>
                                    <span class="badge bg-secondary" id="benchmark-brasil">42</span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span>Empresas Top</span>
                                    <span class="badge bg-secondary" id="benchmark-top">70</span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span>Classe Mundial</span>
                                    <span class="badge bg-secondary" id="benchmark-world">80</span>
                                </div>
                            </div>
                            
                            <div class="mt-4">
                                <h6 class="fw-bold mb-3">Fórmula do Cálculo</h6>
                                <div class="code-block p-3 rounded" style="background: #f8f9fa; font-family: 'Courier New', monospace;">
                                    <div id="nps-formula">NPS = ((Promotores - Detratores) / Total) × 100</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Botão para mostrar análise NPS -->
        <div class="text-center mb-4" id="show-nps-button">
            <button class="btn btn-outline-papello" onclick="toggleNPSAnalysis()">
                <i class="fas fa-microscope me-2"></i>Ver Análise Completa do NPS
            </button>
        </div>
        
        <!-- Distribuições Visuais -->
        <div class="row mb-4">
            <div class="col-lg-6 mb-3">
                <div class="chart-card">
                    <div class="chart-title">
                        <i class="fas fa-trophy"></i>
                        Distribuição por Nível
                    </div>
                    <canvas id="chart-nivel-pie"></canvas>
                </div>
            </div>
            
            <div class="col-lg-6 mb-3">
                <div class="chart-card">
                    <div class="chart-title">
                        <i class="fas fa-exclamation-triangle"></i>
                        Status de Risco
                    </div>
                    <canvas id="chart-risco-bar"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Análises Críticas Estratégicas -->
        <div class="section-header">
            <i class="fas fa-brain section-icon"></i>
            <h2 class="section-title">Análises Críticas</h2>
        </div>
        
        <div class="row mb-4">
            <div class="col-lg-6 mb-3">
                <div class="chart-card">
                    <div class="chart-title">
                        <i class="fas fa-shield-alt"></i>
                        Clientes Premium em Risco
                    </div>
                    <div id="premium-risk-analysis">
                        <div class="text-center py-4">
                            <div class="spinner-border text-success" role="status">
                                <span class="visually-hidden">Carregando...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-6 mb-3">
                <div class="chart-card">
                    <div class="chart-title">
                        <i class="fas fa-trending-down"></i>
                        Métricas em Atenção
                    </div>
                    <div id="metrics-attention">
                        <div class="text-center py-4">
                            <div class="spinner-border text-success" role="status">
                                <span class="visually-hidden">Carregando...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Resumo Executivo -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="alert-card" id="executive-summary">
                    <div class="alert-header">
                        <h4 class="alert-title">
                            <i class="fas fa-clipboard-list me-2"></i>
                            Resumo Executivo
                        </h4>
                        <span class="alert-priority">📋</span>
                    </div>
                    <div class="alert-content">
                        <div class="text-center py-4">
                            <div class="spinner-border text-success" role="status">
                                <span class="visually-hidden">Carregando resumo...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
    </div>
    
</div>
{% endblock %}

{% block page_init %}
loadExecutiveDashboard();
initializeDateFilters();
{% endblock %}

        <!-- Gráficos de Distribuição -->
        <div class="row mb-4">
            <div class="col-lg-6 mb-3">
                <div class="chart-card">
                    <div class="chart-title">
                        <i class="fas fa-chart-pie"></i>
                        Distribuição por Nível
                    </div>
                    <canvas id="chart-nivel-pie"></canvas>
                </div>
            </div>
            
            <div class="col-lg-6 mb-3">
                <div class="chart-card">
                    <div class="chart-title">
                        <i class="fas fa-chart-bar"></i>
                        Status de Risco
                    </div>
                    <canvas id="chart-risco-pie"></canvas>
                </div>
            </div>
        </div>


